<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPU Line Tralis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r16/Stats.min.js"></script>
    <script src="main.js"></script>
    <script type="x-shader/x-vertex" id="buffer_vs">#version 300 es
        const vec3[4] POSITIONS = vec3[](
            vec3(-1.0, -1.0, 0.0),
            vec3(1.0, -1.0, 0.0),
            vec3(-1.0, 1.0, 0.0),
            vec3(1.0, 1.0, 0.0)
        );
        
        const int[6] INDICES = int[](
            0, 1, 2,
            3, 2, 1
        );

        void main(void) {
            vec3 position = POSITIONS[INDICES[gl_VertexID]];
            gl_Position = vec4(position, 1.0);
        }
    </script>
    <script type="x-shader/x-fragment" id="init_trails_fs">#version 300 es
      precision highp float;

      uniform sampler2D uPositionTexture;
      uniform sampler2D uVelocityTexture;

      layout (location = 0) out vec2 o_position;
      layout (location = 1) out vec2 o_velocity;

      void main(void) {

      }
    </script>
    <script type="x-shader/x-fragment" id="update_trails_fs">#version 300 es
        precision highp float;

        uniform sampler2D uPositionTexture;
        uniform sampler2D uVelocityTexture;
        uniform float uTime;
        uniform float uDeltaTime;

        layout (location = 0) out vec2 o_position;
        layout (location = 1) out vec2 o_velocity;

        void main(void) {

            ivec2 coord = ivec2(gl_FragCoord.xy);
            vec2 st = (2.0 * gl_FragCoord.xy - u_resolution) / min(u_resolution.x, u_resolution.y);
            vec2 mouse = (2.0 * u_mousePosition - u_resolution) / min(u_resolution.x, u_resolution.y);

            ivec2 textureSize = textureSize(u_texture, 0);

            vec2 state = texelFetch(u_texture, coord, 0).xy;

            vec2 left = texelFetch(u_texture, ivec2(coord.x != 0 ? coord.x - 1 : textureSize.x -1, coord.y), 0).xy;
            vec2 right = texelFetch(u_texture, ivec2(coord.x != textureSize.x ? coord.x + 1 : 0, coord.y), 0).xy;
            vec2 down = texelFetch(u_texture, ivec2(coord.x, coord.y != 0 ? coord.y - 1 : textureSize.y - 1), 0).xy;
            vec2 up = texelFetch(u_texture, ivec2(coord.x, coord.y != textureSize.y ? coord.y + 1 : 0), 0).xy;

            vec2 lapl = (left + right + down + up - 4.0 * state);
            float du = 0.2079 * lapl.x - state.x * state.y * state.y + u_feed * (1.0 - state.x);
            float dv = 0.105 * lapl.y + state.x * state.y * state.y - state.y * (u_feed + u_kill);
            vec2 dst = state + u_delta * vec2(du, dv);

            if (u_mousePress) {
              vec2 diff = (st - mouse) * 10.0;
              float dist = dot(diff, diff);
              if (dist < 0.03) {
                dst.y = 0.3;
              }
            } 

            o_grayScott = dst;
        }
    </script>
    <script type="x-shader/x-vertex" id="render_vs">#version 300 es
    uniform sampler2D uPositionTexture;
    uniform mat4 mvpMatrix;

    void main(void) {
      vec3 position = texelFetch(uPositionTexture, ivec2(gl_InstanceID, gl_VertexID), 0).xyz;
      gl_Position = mvpMatrix * vec4(position, 1.0);
    }
    </script>
    <script type="x-shader/x-fragment" id="render_gray_scott_fs">#version 300 es
        precision highp float;

        out vec4 fragColor;

        void main(void) {
            fragColor = vec4(1.0);
        }
    </script>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="container"></div>
    <h1>Gray Scott Reaction Diffusion Simulation</h1>
    <div id="parameter_container">
      <div class="parameter"><div class="parameter_name">Feed<span id="disp_feed" class="value"></span></div><input type="range" id="feed" min="0.001" max="0.1" value="0.037" step="0.001"/></div><br>
      <div class="parameter"><div class="parameter_name">Kill<span id="disp_kill" class="value"></span></div><input type="range" id="kill" min="0.001" max="0.1" value="0.06" step="0.001"/></div><br>
    </div>
</body>
</html>

<style>
#container {
  padding-top: 50px;
  position: fixed;
}
canvas {
  position: absolute;
  top: 0;
  bottom: 0;
  right: 0;
  left: 0;
  margin: auto;
}
#parameter_container {
  background-color:rgba(20, 20, 20, 0.95);
  border-radius: 3%;
  padding: 2% 2.5%;
  width: calc(10% + 120px);
  font-family: 'Sen';
  font-size: calc(0.5vw + 11.35px);
  font-weight: 700;
  color: white;
  position: fixed;
  display: block;
  right: 50px;
  transition: all 500ms;
}
.parameter_name {
  width: 100%;
  padding-bottom: 10px;
}
.parameter {
  padding-top: 5px;
}
span {
  float: right;
}
input[type="range"] {
  -webkit-appearance: none;
  appearance: none;
  cursor: pointer;
  outline: none;
  background: rgba(255, 255, 255, 1.0);
  height: 3px;
  width: calc(100%);
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance:none;
  background:rgba(0.0, 0.0, 0.0, 0.0);
  height: 15px;
  width: 15px;
  border: 2px solid #494949;
  border-radius: 50%;
}
h1 {
  font-family: 'Sen';
  font-size: calc(1vw + 25px);
  font-weight: 700;
  left: 100px;
  bottom: 10px;
  position: fixed;
  color: white;
  transition: all 500ms;
}
</style>
